<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LA Metro Buses</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX" crossorigin="anonymous">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <style media="screen">
      #map {
        height: 550px;
      }
      #legend div {
        display: inline-block;
        font-size: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LA Metro Buses</h1>
      <div class="col-xs-12" id="map"></div>
      <div class="pull-left" id="legend"><strong>Speed (km/h):</strong> </div>
      <div class="pull-right">Taylor Denouden (2015)</div>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js"></script>
    <script src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var colorScale = d3.scale.linear().domain(d3.range(0,70,10)).range(["#ffffb2","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"].reverse()).clamp(true);

      var buses = L.layerGroup();
      var map = L.map("map", {
        center: [34.047, -118.24],
        zoom: 14,
        layers: [buses]
      });

      L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.{ext}', {
          attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          subdomains: 'abcd',
          minZoom: 0,
          maxZoom: 20,
          ext: 'png'
      }).addTo(map);


      // Add an SVG element to Leafletâ€™s overlay pane
      map._initPathRoot()
    	var svg = d3.select("#map").select("svg"),
          	g = svg.append("g").attr("class", "leaflet-zoom-hide");

      // Render a legend for the point data
      d3.select("#legend").selectAll("div")
          .data(d3.range(0,70, 10))
        .enter().append("div")
          .style("width", "50px")
          .style("height", "10px")
          .style("background-color", function(d) { return colorScale(d); })
          .attr("class", "text-center")
          .html(function(d) { return d === 60 ? d.toString() + "+" : d; });

      var socket = io();
      socket.on('data', function(data) {
        // console.dir(data);

        var buses = g.selectAll("circle")
            .data(data.data, function(d) { return d.id; });

        buses.transition().duration(20000).delay(function(d, i){ return i*100; })
            .attr("cx", function(d) { return projectPoint(d.lat, d.lon).x; })
            .attr("cy", function(d) { return projectPoint(d.lat, d.lon).y; })
            .style("fill", function(d) { return colorScale(d.kph); });

        buses.enter().append("circle")
            .attr("cx", function(d) { return projectPoint(d.lat, d.lon).x; })
            .attr("cy", function(d) { return projectPoint(d.lat, d.lon).y; })
            .attr("r", "5")
            .style("fill", function(d) { return colorScale(d.kph); });

        buses.exit().remove();

      });

      map.on("viewreset", update);
      update();

      function update() {
        g.selectAll("circle").transition().duration(0).delay(0)
            .attr("cx", function(d) { return projectPoint(d.lat, d.lon).x; })
            .attr("cy", function(d) { return projectPoint(d.lat, d.lon).y; });
      }

      // Use Leaflet to implement a D3 geometric transformation.
      function projectPoint(x, y) {
        return map.latLngToLayerPoint(new L.LatLng(x, y));
      }
    </script>
  </body>
</html>
